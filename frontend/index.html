<script>
  function startBusiness() {
    document.getElementById("mode-selection").style.display = "none";
    document.getElementById("order-container").style.display = "block";
  }

  function endBusiness() {
    document.getElementById("order-container").style.display = "none";
    document.getElementById("summary-section").style.display = "block";
  }

  function showSummary() {
    fetch('/summary')
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          alert(
            `예측 정확도: ${data.average_accuracy_percent}%\n` +
            `평균 지연 시간: ${data.average_delay_seconds}초`
          );
        } else {
          alert(data.message || "요약 정보를 불러올 수 없습니다.");
        }
      })
      .catch(() => alert("서버 오류로 요약 불러오기 실패"));
  }

  function compressMenus(menus) {
    const counts = {};
    menus.forEach(menu => {
      counts[menu] = (counts[menu] || 0) + 1;
    });
    return Object.entries(counts)
      .map(([menu, count]) => count > 1 ? `${menu} x${count}` : menu)
      .join(", ");
  }

  function formatTime(isoString) {
    try {
      return new Date(isoString).toTimeString().split(" ")[0];
    } catch {
      return isoString;
    }
  }

  async function fetchOrders() {
    try {
      const res = await fetch('/orders');
      const data = await res.json();
      const tbody = document.getElementById('order-table');
      tbody.innerHTML = "";
      data.forEach(order => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${order.order_id}</td>
          <td>${compressMenus(order.menus)}</td>
          <td>${formatTime(order.time)}</td>
          <td id="predicted-${order.order_id}">${order.predicted}</td>
          <td>
            <button class="default-button" onclick="addDelay(${order.order_id})">+3분</button>
          </td>
          <td>
            <button class="default-button" onclick="markComplete(${order.order_id})">완료</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    } catch (e) {
      alert("주문 불러오기 실패");
    }
  }

  function addDelay(orderId) {
    fetch(`/delay?order_id=${orderId}&minutes=3`, { method: "POST" })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          document.getElementById(`predicted-${orderId}`).innerText = data.new_predicted;
        } else {
          alert("지연 실패: " + (data.message || "서버 응답 없음"));
        }
      })
      .catch(() => {
        alert("지연 실패: 네트워크 오류");
      });
  }

  function markComplete(orderId) {
    fetch(`/complete?order_id=${orderId}`, { method: "POST" })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          alert(`주문 ${orderId} 완료 처리됨: ${data.completed}`);
        } else {
          alert("완료 실패: " + (data.message || "서버 응답 없음"));
        }
      })
      .catch(() => {
        alert("완료 실패: 네트워크 오류");
      });
  }

  // 자동 갱신
  setInterval(() => {
    if (document.getElementById("order-container").style.display !== "none") {
      fetchOrders();
    }
  }, 3000);
</script>
